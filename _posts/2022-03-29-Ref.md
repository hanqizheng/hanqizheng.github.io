---
layout: post
title: "React çš„ Refs"
author: "Qizheng Han"
---

å†™ React éš¾å…ä¼šçœ‹åˆ°è¿™ä¸ªè¯ã€‚ 

æ¯æ¬¡ç”¨éƒ½æœ‰ä¸€ç§è¿·è¿·ç³Šç³Šçš„æ„Ÿè§‰ï¼Œå¥½åƒå¹¶ä¸æ˜¯çœŸçš„äº†è§£`ref`çš„ç”¨æ³•ã€‚ 

ä»Šå¤©ï¼Œå°±æ¥è®©è‡ªå·±è¿›ä¸€æ­¥äº†è§£ä¸€ä¸‹`ref`ã€‚

# refåˆ°åº•æ˜¯ä»€ä¹ˆ

å…ˆæ¥ç¿»å‡º[Reactå®˜æ–¹æ–‡æ¡£](https://reactjs.org/docs/refs-and-the-dom.html)çš„å®šä¹‰ï¼Œé€å­—çœ‹ä¸€ä¸‹(æœ¬äººç³™ç¿»ï¼Œæœ‰é”™è¯·æŒ‡å‡º)ã€‚

Refs provide a way to access DOM nodes or React elements created in the render method.

`Refs`æä¾›äº†ä¸€ç§åœ¨`render`æ–¹æ³•å†…è·å–`DOM`æˆ–`Reactå…ƒç´ `çš„æ–¹å¼ã€‚

In the typical React dataflow, props are the only way that parent components interact with their children. To modify a child, you re-render it with new props. 

åœ¨Reactçš„`æ•°æ®æµ`ä¸­ï¼Œ`props`æ˜¯çˆ¶ç»„ä»¶ä¸å­ç»„ä»¶çš„å”¯ä¸€é€šä¿¡æ–¹å¼ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡æ›´æ–°(ä¼ å…¥æ–°çš„)`props`æ¥è®©å­ç»„ä»¶`é‡æ–°æ¸²æŸ“`ã€‚


However, there are a few cases where you need to imperatively modify a child outside of the typical dataflow. The child to be modified could be an instance of a React component, or it could be a DOM element. For both of these cases, React provides an escape hatch.

ç„¶è€Œï¼Œåœ¨ä¸€äº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦ä»¥ä¼ ç»Ÿ`æ•°æ®æµä¹‹å¤–`çš„æ–¹å¼ä¿®æ”¹å­ç»„ä»¶ã€‚è€Œè¢«ä¿®æ”¹çš„`child`å¯ä»¥æ˜¯` React ç»„ä»¶çš„ä¸€ä¸ªå®ä¾‹`ï¼Œæˆ–è€…ä¸€ä¸ª`DOM å…ƒç´ `ã€‚

å¯¹äºè¿™äº›æƒ…å†µï¼ŒReactæä¾›äº†`Refs`ã€‚


So... æ˜¯ä»€ä¹ˆæƒ…å†µä¸‹ï¼Œéœ€è¦ä»¥ä¼ ç»Ÿæ•°æ®æµä»¥å¤–çš„æ–¹å¼å»ä¿®æ”¹Refå‘¢ï¼Ÿä»€ä¹ˆæƒ…å†µå‘¢ï¼Ÿ

# ä¸ºä»€ä¹ˆéœ€è¦ref

å¸¦ç€ç–‘æƒ‘ï¼Œå‘ç°å®˜æ–¹æ–‡æ¡£ç´§æ¥ç€å°±ç»™å‡ºäº†ä¸€äº›å¯ä»¥ä½¿ç”¨`Refs`çš„good caseï¼š

- æ“æ§ å…‰æ ‡focusã€æ–‡æœ¬é€‰ä¸­æˆ–è€…éŸ³é¢‘æ’­æ”¾
- è§¦å‘ä¸€äº›å—æ§çš„(å‘½ä»¤å¼)Animation
- ç»§æ‰¿ä¸€äº›ç¬¬ä¸‰æ–¹çš„DOMåº“


## æ‰€ä»¥åˆ°åº•ä»€ä¹ˆæ˜¯ä¼ ç»Ÿæ•°æ®æµæ„å¤–çš„æ–¹å¼å‘¢ï¼Ÿ

ä»¥ä¸‹æ˜¯æˆ‘ä¸ªäººçš„ç†è§£ï¼š

åœ¨å®˜æ–¹æ–‡æ¡£ä¸­ï¼Œæ‰€è¯´çš„`ä¼ ç»Ÿæ•°æ®æµ`ï¼Œå…¶å®å°±æ˜¯**å•å‘æ•°æ®æµ**ã€‚

propsåƒæ°´æµä¸€æ ·ï¼Œæµå…¥å­ç»„ä»¶ï¼Œç„¶åæ•°æ®åœ¨å­ç»„ä»¶å†…èµ·ä½œç”¨ã€‚

è€Œrefçš„å¼•å…¥å°±åƒæ˜¯â€œæ‰“ç ´â€äº†è¿™æ ·çš„æ•°æ®æµå½¢å¼ã€‚å¯èƒ½è¯´â€œæ‰“ç ´â€ä¸å¤ªå‡†ç¡®ï¼Œåªæ˜¯ä¸éµå¾ªè¿™æ ·çš„æ•°æ®æµå½¢å¼ã€‚

é€šè¿‡æš´éœ²å­ç»„ä»¶çš„refç»™çˆ¶çº§ç»„ä»¶ï¼Œè¿™æ ·å°±å¥½åƒå®ç°äº†å­ç»„ä»¶çš„æ•°æ®æˆ–è¡Œä¸ºâ€œé€†æµè€Œä¸Šâ€çš„æ•ˆæœã€‚

è¿˜æœ‰ä¸€ç§æƒ…å½¢å°±æ˜¯éœ€è¦æ“ä½œä¸€äº›DOMçš„ç‰¹æœ‰è¡Œä¸ºæˆ–å±æ€§ï¼Œæ¯”å¦‚focus / blurä¹‹ç±»çš„ï¼Œä¹Ÿéœ€è¦ç”¨åˆ°refã€‚

![](/assets/img/2022-03-26/ref.png)


ä¸‹é¢ç»™å‡ºRefsçš„åŸºæœ¬ç”¨æ³•

> [ä¾‹å­æ¥è‡ªReactå®˜æ–¹æ–‡æ¡£](https://zh-hans.reactjs.org/docs/refs-and-the-dom.html#adding-a-ref-to-a-class-component)

## DOMèŠ‚ç‚¹ä½¿ç”¨Refs

```jsx
// ç»™DOMèŠ‚ç‚¹æ·»åŠ ref
{% raw %}
class CustomTextInput extends React.Component {
  constructor(props) {
    super(props);
    // åˆ›å»ºä¸€ä¸ª ref æ¥å­˜å‚¨ textInput çš„ DOM å…ƒç´ 
    this.textInput = React.createRef();
    this.focusTextInput = this.focusTextInput.bind(this);
  }

  focusTextInput() {
    // ç›´æ¥ä½¿ç”¨åŸç”Ÿ API ä½¿ text è¾“å…¥æ¡†è·å¾—ç„¦ç‚¹
    // æ³¨æ„ï¼šæˆ‘ä»¬é€šè¿‡ "current" æ¥è®¿é—® DOM èŠ‚ç‚¹
    this.textInput.current.focus();
  }

  render() {
    // å‘Šè¯‰ React æˆ‘ä»¬æƒ³æŠŠ <input> ref å…³è”åˆ°
    // æ„é€ å™¨é‡Œåˆ›å»ºçš„ `textInput` ä¸Š
    return (
      <div>
        <input
          type="text"
          ref={this.textInput} />
        <input
          type="button"
          value="Focus the text input"
          onClick={this.focusTextInput}
        />
      </div>
    );
  }
}
{% endraw %}
```

> [ä¾‹å­æ¥è‡ªReactå®˜æ–¹æ–‡æ¡£](https://zh-hans.reactjs.org/docs/refs-and-the-dom.html#refs-and-function-components)

## React.Elementä½¿ç”¨Refs

```jsx
// ç»™React.Elementæ·»åŠ ref
{% raw %}
class AutoFocusTextInput extends React.Component {
  constructor(props) {
    super(props);
    this.textInput = React.createRef();
  }

  componentDidMount() {
    this.textInput.current.focusTextInput();
  }

  render() {
    return (
      <CustomTextInput ref={this.textInput} />
    );
  }
}
{% endraw %}
```

è¿™ä¸ªä¾‹å­è·Ÿä¸Šé¢çš„DOMèŠ‚ç‚¹æ˜¯æœ‰ä¸åŒçš„ï¼ŒDOMèŠ‚ç‚¹æ˜¯htmlä¸­çš„å·²æœ‰æ ‡ç­¾ã€‚è€Œç°åœ¨è¿™ä¸ªä¾‹å­ä¸­çš„`CustomTextInput`æ˜¯æˆ‘ä»¬ç”¨Reactè‡ªå·±å†™çš„ç»„ä»¶ã€‚

## Refs å’Œ å‡½æ•°ç»„ä»¶

å‡½æ•°ç»„ä»¶æœ‰ä¸€ä¸ªç‰¹ç‚¹ï¼Œå…¶å® **å¹¶ä¸æ˜¯** å‡½æ•°ç»„ä»¶çš„ç‰¹ç‚¹ï¼Œè€Œæ˜¯å‡½æ•°å’Œclassæœ¬èº«çš„ç‰¹ç‚¹ã€‚

**ç±»æ˜¯éœ€è¦å®ä¾‹åŒ–å¯¹è±¡çš„**ã€‚æ‰€ä»¥æˆ‘ä»¬å¯¹ç±»ç»„ä»¶ä½¿ç”¨refså®é™…ä¸Šæ˜¯å°†ç±»ç»„ä»¶å®ä¾‹åŒ–çš„å¯¹è±¡ä½œä¸ºrefsçš„currentå€¼ã€‚

![](../assets/img/2022-03-26/ref_current.png)

ä½†æ˜¯å‡½æ•°æ²¡æœ‰å®ä¾‹åŒ–çš„å¯¹è±¡ï¼Œæ‰€ä»¥refsä¹Ÿå°±æ²¡æœ‰å€¼ã€‚

> By default, you may not use the ref attribute on function components because they donâ€™t have instances:


```jsx
{% raw %}
function MyFunctionComponent() {
  return <input />;
}

class Parent extends React.Component {
  constructor(props) {
    super(props);
    this.textInput = React.createRef();
  }
  render() {
    // This will *not* work!
    return (
      <MyFunctionComponent ref={this.textInput} />
    );
  }
}
{% endraw %}
```

## forwardRef

ä½†æ˜¯å¹¶éæ— è®¡å¯æ–½ã€‚

æˆ‘ä»¬å¯ä»¥é€šè¿‡refè½¬å‘æ¥å®Œæˆã€‚ä»€ä¹ˆæ˜¯refè½¬å‘å‘¢ï¼Ÿæ¥çœ‹çœ‹å®˜æ–¹çš„ğŸŒ°

```jsx
{% raw %}
const FancyButton = React.forwardRef((props, ref) => (
  <button ref={ref} className="FancyButton">
    {props.children}
  </button>
));

// You can now get a ref directly to the DOM button:
const ref = React.createRef();
<FancyButton ref={ref}>Click me!</FancyButton>;
{% endraw %}
```

> [ä¾‹å­æ¥è‡ªReactå®˜æ–¹æ–‡æ¡£](https://zh-hans.reactjs.org/docs/refs-and-the-dom.html#refs-and-function-components)


è¿™ä¸ªä¾‹å­å¾ˆæ˜æ˜¾ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠ`forwardRef`ç†è§£æˆä¸€ä¸ª`é«˜é˜¶ç»„ä»¶`ã€‚

å‡½æ•°ç»„ä»¶æœ¬èº«æ²¡æœ‰å®ä¾‹æ‰€ä»¥æˆ‘ä»¬å³ä½¿ç»™å®ƒä¼ å…¥äº†refä¹Ÿæ˜¯ä¸èµ·ä½œç”¨çš„ã€‚

è€Œ`forwardRef`å°±æ˜¯è®©å‡½æ•°ç»„ä»¶èƒ½å¤Ÿæ¥æ”¶refå±æ€§ã€‚

æ€ä¹ˆåšåˆ°çš„å‘¢ï¼Ÿ

å…¶å®å°±æ˜¯è¿”å›çš„ç»„ä»¶ç¬¬äºŒä¸ªå‚æ•°æ¥å—refè¿™ä¸ªå‚æ•°äº†ã€‚


## useImperativeHandle

`useImperativeHandle`ä¸`forwardRef`æ­é…ä½¿ç”¨ã€‚

`forwardRef`è®©å‡½æ•°ç»„ä»¶å…·å¤‡äº†æ¥æ”¶refçš„èƒ½åŠ›ã€‚

`useImperativeHandle`èƒ½å¤Ÿæ§åˆ¶å¯¹å¤–æš´éœ²çš„refæ‰€å…·å¤‡çš„å†…å®¹ã€‚è¿™æ ·æˆ‘ä»¬å°±ä¸éœ€è¦å°†æ‰€æœ‰å†…å®¹éƒ½å…¨ç›˜æ‹–å‡ºäº†ã€‚


```jsx
{% raw %}
function FancyInput(props, ref) {
  const inputRef = useRef();
  useImperativeHandle(ref, () => ({
    focus: () => {
      inputRef.current.focus();
    }
  }));
  return <input ref={inputRef} />;
}
FancyInput = forwardRef(FancyInput);
{% endraw %}
```

ä¾‹å­é‡Œçš„`useImperativeHandle`å°±æ§åˆ¶åˆ°åªæš´éœ²äº†`focus`è¿™ä¸ªæ–¹æ³•ã€‚


## useRef

åˆšåˆšæ‰æŒ‡å‡ºå‡½æ•°ç»„ä»¶ä¸èƒ½ä½¿ç”¨refï¼Œéœ€è¦é€šè¿‡forwardRefæ¥ç»„åˆæ‰å¯ä»¥ã€‚

é‚£useRefæ˜¯ä»€ä¹ˆæ ·çš„å­˜åœ¨å‘¢ï¼Ÿ

é¦–å…ˆéœ€è¦åˆ†æ¸…æ¥šä¸€ä¸ªæ¦‚å¿µï¼Œå‡½æ•°ç»„ä»¶ä¸èƒ½ä½¿ç”¨refæ˜¯æŒ‡ä¸æ¥å—refè¿™ä¸ªå±æ€§å€¼ã€‚å› ä¸ºæ²¡æœ‰å®ä¾‹ã€‚

ä½†æ˜¯å†…éƒ¨ä¾ç„¶æ˜¯å¯ä»¥ä½¿ç”¨refçš„ï¼


```jsx
{% raw %}
function TextInputWithFocusButton() {
  const inputEl = useRef(null);
  const onButtonClick = () => {
    // `current` points to the mounted text input element
    inputEl.current.focus();
  };
  return (
    <>
      <input ref={inputEl} type="text" />
      <button onClick={onButtonClick}>Focus the input</button>
    </>
  );
}
{% endraw %}
```

ä¹‹å‰è¯´è¿‡ref.current å…¶å®å°±æ˜¯ç»„ä»¶å®ä¾‹ã€‚

ä½†æ˜¯useRefæ‰€åˆ›å»ºçš„refæ¯”è¿˜è¦å†çµæ´»ï¼Œå› ä¸ºuseRefæ‰€åˆ›å»ºçš„currentå¯ä»¥èµ‹å€¼æˆä»»æ„å¯å˜å€¼ã€‚

å…¶å®å°±æ˜¯ä¸€ä¸ªæ™®é€šçš„jså¯¹è±¡

```
{ current: ... }
```

> [ä¾‹å­æ¥è‡ªReactå®˜æ–¹æ–‡æ¡£](https://reactjs.org/docs/hooks-reference.html#useimperativehandle)

useRefç”Ÿæˆçš„å¯¹è±¡å”¯ä¸€çš„ä¸åŒç‚¹å°±æ˜¯useRef**æ¯æ¬¡æ¸²æŸ“æ‰€è¿”å›çš„éƒ½æ˜¯åŒä¸€ä¸ªjså¯¹è±¡**ã€‚


# ä¸è¦è¿‡åº¦ä½¿ç”¨Refs

å¾ˆå¤šåœºæ™¯æ˜¯å¯ä»¥é€šè¿‡propsè§£å†³çš„

è€Œrefsç»™äººä¸€ç§ç«‹ç«¿è§å½±ï¼Œä»€ä¹ˆéƒ½èƒ½æ‹¿åˆ°çš„æ„Ÿè§‰ï¼Œå°±å¾ˆå®¹æ˜“å‡ºç°æ»¥ç”¨





# å‚è€ƒ

- [Refs and the DOM](https://reactjs.org/docs/refs-and-the-dom.html)
- [Forwarding Refs](https://reactjs.org/docs/forwarding-refs.html)
- [ä»é›¶å¼€å§‹çš„reactå…¥é—¨æ•™ç¨‹ï¼ˆåä¸€ï¼‰ï¼Œreact ref è¯¦è§£ï¼Œä¸‰ç§å†™æ³•ä¸ ref è½¬å‘ï¼ˆä¼ é€’ï¼‰](https://www.cnblogs.com/echolun/p/15046086.html)
- [A Complete Guide to useEffect](https://overreacted.io/a-complete-guide-to-useeffect/#swimming-against-the-tide)